From 763a7c4d05a6a9031e22488d834600610ce28762 Mon Sep 17 00:00:00 2001
From: Holger Brunn <hbrunn@therp.nl>
Date: Wed, 4 Mar 2015 12:41:07 +0100
Subject: [PATCH] [IMP] allow dataurls if they point to images

fixes #145
---
 src/lxml/html/clean.py | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

--- a/src/lxml/html/clean.py
+++ b/src/lxml/html/clean.py
@@ -76,9 +76,16 @@
 
 # All kinds of schemes besides just javascript: that can cause
 # execution:
-_is_javascript_scheme = re.compile(
+_is_image_dataurl = re.compile(
+    r'^data:image/.+;base64', re.I).search
+_is_possibly_malicious_scheme = re.compile(
     r'(?:javascript|jscript|livescript|vbscript|data|about|mocha):',
     re.I).search
+def _is_javascript_scheme(s):
+    if _is_image_dataurl(s):
+        return None
+    return _is_possibly_malicious_scheme(s)
+
 _substitute_whitespace = re.compile(r'[\s\x00-\x08\x0B\x0C\x0E-\x19]+').sub
 # FIXME: should data: be blocked?
 
